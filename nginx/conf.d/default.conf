# Server HTTP su porta 80 - NO REDIRECT
server {
  listen 80;
  server_name localhost nurebo.com www.nurebo.com;

  # Homepage HTTP
  location / {
    return 200 "HTTP (porta 80) attivo - Nessun redirect, bastardo!";
    add_header Content-Type text/plain;
  }

  # Tutte le routes HTTP
  location /kafka-ui/ {
    proxy_pass http://kafka-ui:8080/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto http;
  }

  location /connect/ {
    proxy_pass http://debezium:8083/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto http;
  }

  location /phpmyadmin/ {
    proxy_pass http://phpmyadmin:80/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto http;
  }

  location /fastapi/ {
    proxy_pass http://fastapi-flink:3000/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto http;
  }

  location /flask/ {
    proxy_pass http://flask-spark:5000/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto http;
  }

  location /flink/ {
    proxy_pass http://flink-jobmanager:8091/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto http;
  }

  location /spark/ {
    proxy_pass http://spark-master:8089/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto http;
  }
}

# Server HTTPS su porta 443 - INDIPENDENTE
server {
  listen 443 ssl;
  server_name localhost nurebo.com www.nurebo.com;

  ssl_certificate /etc/nginx/certs/nginx.crt;
  ssl_certificate_key /etc/nginx/certs/nginx.key;

  # Homepage HTTPS
  location / {
    return 200 "HTTPS (porta 443) attivo - Nessun redirect, lurido cazzone!";
    add_header Content-Type text/plain;
  }

  # Tutte le routes HTTPS
  location /kafka-ui/ {
    proxy_pass http://kafka-ui:8080/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  location /connect/ {
    proxy_pass http://debezium:8083/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
  }

  location /phpmyadmin/ {
    proxy_pass http://phpmyadmin:80/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
  }

  location /fastapi/ {
    proxy_pass http://fastapi-flink:3000/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
  }

  location /flask/ {
    proxy_pass http://flask-spark:5000/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
  }

  location /flink/ {
    proxy_pass http://flink-jobmanager:8091/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
  }

  location /spark/ {
    proxy_pass http://spark-master:8089/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
  }
}